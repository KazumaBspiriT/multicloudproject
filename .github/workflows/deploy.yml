name: Multi-Cloud Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      target_cloud:
        description: 'Target Cloud (aws, azure, gcp)'
        required: true
        default: 'aws'
      deployment_mode:
        description: 'Deployment Mode (k8s or static)'
        required: true
        default: 'k8s'
      
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      
      # Time Tracking Start
      - name: Start Provisioning Timer
        id: timer_start
        run: echo "::set-output name=start::$(date +%s)"
      
      ## 1. Terraform Provisioning ##
      - name: Configure AWS Credentials (for AWS only)
        if: ${{ inputs.target_cloud == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init and Plan
        id: plan
        run: |
          terraform init
          terraform plan -var="target_cloud=${{ inputs.target_cloud }}" -var="deployment_mode=${{ inputs.deployment_mode }}" -out=tfplan.out

      - name: Terraform Apply (Provisioning)
        id: apply
        run: terraform apply tfplan.out

      # Get Outputs
      - name: Process Outputs
        run: |
          if [ "${{ inputs.deployment_mode }}" == "k8s" ]; then
            KUBECONFIG_RAW=$(terraform output -raw kubeconfig_raw)
            echo "KUBECONFIG_RAW=$KUBECONFIG_RAW" >> $GITHUB_ENV
            echo "$KUBECONFIG_RAW" > kubeconfig.yaml
            CLUSTER_ENDPOINT=$(terraform output -raw cluster_endpoint)
            echo "CLUSTER_ENDPOINT=$CLUSTER_ENDPOINT" >> $GITHUB_ENV
          fi
          
          if [ "${{ inputs.deployment_mode }}" == "static" ]; then
            WEBSITE_URL=$(terraform output -raw website_url)
            echo "WEBSITE_URL=$WEBSITE_URL" >> $GITHUB_ENV
          fi

      # --- Measure Provisioning Time ---
      - name: Measure Provisioning Time
        id: time_provisioning
        run: |
          end=$(date +%s)
          start=${{ steps.timer_start.outputs.start }}
          echo "::set-output name=duration::$((end - start))"
          echo "Provisioning Time: $((end - start)) seconds"
          
      ## 2. Ansible Configuration (K8s Mode Only) ##
      - name: Setup Python and Ansible
        if: ${{ inputs.deployment_mode == 'k8s' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Install Ansible and Kubernetes requirements
        if: ${{ inputs.deployment_mode == 'k8s' }}
        run: |
          pip install ansible kubernetes openshift jmespath helm
          ansible-galaxy collection install kubernetes.core community.general

      - name: Run Ansible Configuration and Deployment
        if: ${{ inputs.deployment_mode == 'k8s' }}
        id: configure
        env:
          KUBECONFIG: kubeconfig.yaml
        run: |
          ansible-playbook -i ansible/inventory.yml ansible/playbook.yml \
            --extra-vars "deployment_mode=${{ inputs.deployment_mode }}"
      
      ## 3. Smoke Test (Using native CURL) ##
      - name: Run Smoke Test (Static Site Check)
        if: ${{ inputs.deployment_mode == 'static' }}
        run: |
          URL=${{ env.WEBSITE_URL }}
          echo "Checking Static Website URL: $URL"
          MAX_RETRIES=10
          DELAY=5
          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $URL)
            if [ "$HTTP_STATUS" == "200" ]; then
              echo "✅ Website is up! Status 200."
              exit 0
            fi
            echo "Attempt $i/$MAX_RETRIES failed. Status: $HTTP_STATUS. Retrying in $DELAY seconds..."
            sleep $DELAY
          done
          echo "❌ Static website failed to respond with 200 after $MAX_RETRIES attempts."
          exit 1
          
      - name: Run Smoke Test (K8s Service Check)
        if: ${{ inputs.deployment_mode == 'k8s' }}
        run: |
          echo "Cluster API Endpoint: ${{ env.CLUSTER_ENDPOINT }}"
          echo "Smoke test deferred due to long LoadBalancer provisioning time."
          
      ## 4. Cleanup ##
      - name: Terraform Destroy
        if: always()
        run: |
          terraform destroy -auto-approve -var="target_cloud=${{ inputs.target_cloud }}" -var="deployment_mode=${{ inputs.deployment_mode }}"

      - name: Publish Metrics
        run: |
          echo "--- FINAL METRICS ---"
          echo "Cloud: ${{ inputs.target_cloud }}, Mode: ${{ inputs.deployment_mode }}"
          echo "Provisioning Time (s): ${{ steps.time_provisioning.outputs.duration }}"